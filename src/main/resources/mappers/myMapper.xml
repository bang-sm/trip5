<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mappers.myMapper">
	
	<select id="selectUuid" parameterType="com.sm.domain.MemberVO" resultType="com.sm.domain.MemberVO">
	SELECT 
		uuid 
	FROM 
		member 
	WHERE 
		membernick = #{membernick}
	</select>
	
	
	<insert id="insertBlackList" parameterType="int">
		INSERT INTO 
			blackList 
		VALUES (#{myuid}, #{otheruid})
	</insert>
	
	<select id="selectBlackList" parameterType="int" resultType="com.sm.domain.MemberVO">
		SELECT 
			black_uuid as blackuuid
		FROM
			blackList 
		WHERE
			uuid = #{uuid} 
	</select>
	
	<delete id="deleteBlackList" parameterType="int">
		DELETE FROM 
			blackList 
		WHERE 
			black_uuid = #{otheruid}
	</delete>
	
	<insert id="sendToMsg" parameterType="com.sm.domain.MessageVO">
		INSERT INTO 
			messageList (msg_regdate, 
			msg_content, 
			from_id, 
			send_id, 
			msg_subject) 
		VALUES
			(now(), #{msgcontent}, #{fromid}, #{sendid}, #{msgsubject})
	</insert>
	
	<select id="sendMessage" parameterType="com.sm.domain.MessageVO" resultType="com.sm.domain.MessageVO">
		SELECT 
			m.membernick membernick, 
			msg_id msgid, 
			msg_regdate msgregdate, 
			msg_content msgcontent, 
			from_id fromid, 
			send_id sendid, 
			msg_subject msgsubject 
		FROM 
			member m, messageList l 
		WHERE 
			m.uuid = l.from_id AND 
			l.send_id = #{sendid} AND
			l.msg_delsnt = 2
		ORDER BY 
			msg_regdate desc
	</select>
	
	<select id="countMessage" parameterType="com.sm.domain.MessageVO" resultType="int">
		SELECT 
			count(*) 
		FROM 
			messageList 
		WHERE
		<choose>
			<when test="fromid != 0">
				from_id = #{fromid} 
				AND
				msg_unwrite = 1
			</when>
			<otherwise>
				from_id = #{sendid}
				AND
				msg_unwrite = 1
			</otherwise>
		</choose> 
	</select>
	
	<select id="receive" parameterType="com.sm.domain.MessageVO" resultType="com.sm.domain.MessageVO">
	SELECT 
		m.membernick membernick, 
		msg_id msgid, 
		msg_regdate msgregdate, 
		msg_content msgcontent, 
		from_id fromid, 
		send_id sendid, 
		msg_subject msgsubject,
		msg_unwrite msgunwrite 
	FROM 
		member m, 
		messageList l 
	WHERE 
		m.uuid = l.send_id AND 
		l.from_id = #{fromid} AND
		l.msg_delrcv = 2
	ORDER BY 
		msg_regdate desc
	</select>
	
	<select id="clipread" parameterType="com.sm.domain.MessageVO" resultType="com.sm.domain.MessageVO">
	SELECT 
		m.membernick membernick, 
		msg_id msgid, 
		msg_regdate msgregdate, 
		msg_content msgcontent, 
		from_id fromid, 
		send_id sendid, 
		msg_subject msgsubject, 
		t.membernick othernick
	FROM 
		member m, 
		messageList l,
		(SELECT membernick FROM member WHERE uuid = #{sendid}) t
	WHERE 
		m.uuid = l.from_id AND
		l.msg_id = #{msgid};
	</select>
	
	<update id="readed" parameterType="com.sm.domain.MessageVO">
		UPDATE 
			messageList 
		SET 
			msg_unwrite = 0 
		WHERE 
			msg_id = #{msgid}
	</update>
	
	<select id="clipTrash" parameterType="com.sm.domain.MessageVO" resultType="com.sm.domain.MessageVO">
		SELECT
			m.membernick membernick,
			msg_id msgid,
			msg_regdate msgregdate,
			msg_content msgcontent,
			from_id fromid,
			send_id sendid,
			msg_subject msgsubject,
			msg_delsnt msgdelsnt,
			msg_delrcv msgdelrcv
		FROM
			member m,
			messageList l
		WHERE
			m.uuid = l.from_id AND
			(from_id = #{fromid} OR send_id = #{sendid})
			AND
			(l.msg_delsnt = 1 OR l.msg_delrcv = 1)
		ORDER BY
			msg_regdate DESC
	</select>
	
	<update id="gotoTrash" parameterType="Map">
		UPDATE
			messageList 
		SET 
		<choose>
			<when test="sendid != null">
			msg_delsnt = 1 
			</when>
			<otherwise>
			msg_delrcv = 1
			</otherwise>		
		</choose>
		WHERE msg_id IN (
			<foreach collection='messageid' item="item" separator=",">
				#{item}
			</foreach>
		)
	</update>
</mapper>










