<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mappers.travelMapper">

	<!-- 스토리등록 -->
	<insert id="storyRegist" parameterType="com.sm.domain.TravelVO">
		INSERT INTO travel_story(
			tsid,
			uuid,
			tstitle,
			tslike,
			tsregdate,
			tshashtagone,
			tsstartdate,
			tsenddate
			)
		VALUES(
			tsid,
			9,
			#{tstitle},
			#{tslike},
			tsregdate,
			#{tshashtagone},
			#{tsstartdate},
			#{tsenddate},
			tsfare
			);
	</insert>
	<insert id="story_detail_Regist">
	
		<!-- 방금 insert된  부모의 키값을 알아오기 위한 쿼리문 -->
	 	<selectKey resultType="int" keyProperty="tsid" order="BEFORE">
        	SELECT MAX(tsid) FROM travel_story        
    	</selectKey>
			INSERT INTO travel_story_info
			(
				tsiid,
				tsid,
				tsidDay,
				tsititle,
				tsicomment
			)
			VALUES
			<foreach collection="infoList" item="type" separator=",">
			(
				tsiid,
				#{tsid},
				#{type.tsidDay},
				#{type.tsititle},
				#{type.tsicomment}
			)
			</foreach>
	</insert>
	
	<insert id="travel_firstSave" useGeneratedKeys="true" keyProperty="tsid"  parameterType="com.sm.domain.TravelVO">
		INSERT INTO travel_story VALUES(
			tsid,
			7,
			#{tstitle},
			tslike,
			now(),
			'해쉬태그',
			#{tsstartdate},
			#{tsenddate},
			tempsave
		)
	</insert>
	
	<insert id="travel_info_temp_save" useGeneratedKeys="true" keyProperty="tsiid" parameterType="com.sm.domain.TravelInfoVO">
		INSERT INTO travel_story_info VALUES(
			tsiid,
			#{tsid},
			#{tsidDay ,jdbcType=INTEGER},
			#{tsititle ,jdbcType=VARCHAR},
			#{tsicomment ,jdbcType=VARCHAR}
		)
	</insert>
	
	<select id="getTravelStory" parameterType="hashmap" resultType="com.sm.domain.TravelVO">
		SELECT 	
			tsid,
			uuid,
			tstitle,
			tslike,
			tsregdate,
			tshashtagone,
			tsstartdate,
			tsenddate,
			DATEDIFF(tsenddate ,tsstartdate )+1 AS datediff,
			tempsave 
		FROM
			travel_story 
		WHERE
			tsid=#{tsid} AND uuid=#{uuid};
	</select>
	
	<select id="getTravelInfo" resultType="com.sm.domain.TravelInfoVO">
		SELECT 
			*
		FROM
			travel_story_info 
		WHERE
			tsid=#{tsid};
	</select>
	<select id="getTravelRootInfo" resultType="com.sm.domain.TravelInfoRootVO">
		SELECT 
			*
		FROM
			tsi_root 
		WHERE
			tsid=#{tsid};
	</select>
	
	<update id="tempSaveTravelInfo" parameterType="Map">
		INSERT INTO travel_story_info
			(
				tsiid,
				tsid,
				tsidDay,
				tsititle,
				tsicomment
			)
			VALUES
			<foreach collection="infoList" item="type" separator=",">
			(
				#{type.tsiid},
				#{type.tsid},
				#{type.tsidDay},
				#{type.tsititle},
				#{type.tsicomment}
			)
			</foreach>
			ON DUPLICATE KEY UPDATE
				tsititle = values(tsititle),
				tsicomment = values(tsicomment)
	</update>
	
	<update id="tempSaveTravleRoot" parameterType="Map">
		INSERT INTO tsi_root
			(
				tsid,
				tsirootname,
				tsirootorder,
				tsirootvehicle
			)
			VALUES
			<foreach collection="rootList" item="type" separator=",">
			(
				#{type.tsid},
				#{type.tsirootname},
				#{type.tsirootorder},
				#{type.tsirootvehicle}
			)
			</foreach>
			ON DUPLICATE KEY UPDATE
				tsirootname = values(tsirootname),
				tsirootorder = values(tsirootorder),
				tsirootvehicle = values(tsirootvehicle)
	</update>
	
	<delete id="travel_root_delete">
		DELETE FROM tsi_root
		WHERE
			tsid=#{tsid} AND tsirootorder=#{tsirootorder}
	</delete>
	
	<insert id="travel_reply_save" parameterType="Map">
		INSERT INTO travel_story_reply 
		VALUES
		(
			ts_reply_id,
			#{uuid},
			#{reply.tsReplyComment},
			#{reply.tsId},
			reply_regdate
		)
	</insert>

</mapper>